module brent_kung_adder_256 (
    input  logic [255:0] A,
    input  logic [255:0] B,
    input  logic [1:0]   word_mode,   // 00: scalar, 01: vec32, 10: vec16
    input  logic         cin,
    output logic [255:0] sum,
    output logic         cout
);

    localparam MODE_64 = 2'b00;
    localparam MODE_32 = 2'b11;
    localparam MODE_16 = 2'b10;

    logic [255:0] G, P;
    logic [256:0] C;

    // Step 1: Bitwise G/P
    genvar i;
    generate
        for (i = 0; i < 256; i++) begin : gp_gen
            assign G[i] = A[i] & B[i];
            assign P[i] = A[i] ^ B[i];
        end
    endgenerate

    // Step 2: Up-sweep: compute group prefixes at sparse nodes
    // Tree level wires
    logic [255:0] G1, G2, G3, G4, G5, G6, G7, G8;
    logic [255:0] P1, P2, P3, P4, P5, P6, P7;

    // Level 1 (distance 1)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 1 && (i & 1) == 1) begin
                assign G1[i] = G[i] | (P[i] & G[i-1]);
                assign P1[i] = P[i] & P[i-1];
            end else begin
                assign G1[i] = G[i];
                assign P1[i] = P[i];
            end
        end
    endgenerate

    // Level 2 (distance 2)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 3 && (i & 3) == 3) begin
                assign G2[i] = G1[i] | (P1[i] & G1[i-2]);
                assign P2[i] = P1[i] & P1[i-2];
            end else begin
                assign G2[i] = G1[i];
                assign P2[i] = P1[i];
            end
        end
    endgenerate

    // Level 3 (distance 4)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 7 && (i & 7) == 7) begin
                assign G3[i] = G2[i] | (P2[i] & G2[i-4]);
                assign P3[i] = P2[i] & P2[i-4];
            end else begin
                assign G3[i] = G2[i];
                assign P3[i] = P2[i];
            end
        end
    endgenerate

    // Level 4 (distance 8)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 15 && (i & 15) == 15) begin
                assign G4[i] = G3[i] | (P3[i] & G3[i-8]);
                assign P4[i] = P3[i] & P3[i-8];
            end else begin
                assign G4[i] = G3[i];
                assign P4[i] = P3[i];
            end
        end
    endgenerate

    // Level 5 (distance 16)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 31 && (i & 31) == 31) begin
                assign G5[i] = (word_mode != MODE_16) ? (G4[i] | (P4[i] & G4[i-16])) : G4[i];
                assign P5[i] = (word_mode != MODE_16) ? (P4[i] & P4[i-16])           : P4[i];
            end else begin
                assign G5[i] = G4[i];
                assign P5[i] = P4[i];
            end
        end
    endgenerate

    // Level 6 (distance 32)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 63 && (i & 63) == 63) begin
                assign G6[i] = (word_mode == MODE_64) ? (G5[i] | (P5[i] & G5[i-32])) : G5[i];
                assign P6[i] = (word_mode == MODE_64) ? (P5[i] & P5[i-32])           : P5[i];
            end else begin
                assign G6[i] = G5[i];
                assign P6[i] = P5[i];
            end
        end
    endgenerate

    // Level 7 (distance 64)
    generate
        for (i = 0; i < 256; i++) begin
            if (i >= 127 && (i & 127) == 127) begin
                assign G7[i] = (word_mode == MODE_64) ? (G6[i] | (P6[i] & G6[i-64])) : G6[i];
                assign P7[i] = (word_mode == MODE_64) ? (P6[i] & P6[i-64])           : P6[i];
            end else begin
                assign G7[i] = G6[i];
                assign P7[i] = P6[i];
            end
        end
    endgenerate

    // Level 8 (distance 128, final G only)
    generate
        for (i = 0; i < 256; i++) begin
            if (i == 255) begin
                assign G8[i] = (word_mode == MODE_64) ? (G7[i] | (P7[i] & G7[i-128])) : G7[i];
            end else begin
                assign G8[i] = G7[i];
            end
        end
    endgenerate

    // Step 3: Down-sweep â€” assign carries using prefix fanout
    always_comb begin
        C[  0] = (word_mode == MODE_64) ? cin : 1'b0;
        C[  1] = G8[  0] | (P7[  0] & C[  0]);
        C[  2] = G8[  1] | (P7[  1] & C[  0]);
        C[  3] = G8[  2] | (P7[  2] & C[  2]);
        C[  4] = G8[  3] | (P7[  3] & C[  0]);
        C[  5] = G8[  4] | (P7[  4] & C[  4]);
        C[  6] = G8[  5] | (P7[  5] & C[  4]);
        C[  7] = G8[  6] | (P7[  6] & C[  6]);
        C[  8] = G8[  7] | (P7[  7] & C[  0]);
        C[  9] = G8[  8] | (P7[  8] & C[  8]);
        C[ 10] = G8[  9] | (P7[  9] & C[  8]);
        C[ 11] = G8[ 10] | (P7[ 10] & C[ 10]);
        C[ 12] = G8[ 11] | (P7[ 11] & C[  8]);
        C[ 13] = G8[ 12] | (P7[ 12] & C[ 12]);
        C[ 14] = G8[ 13] | (P7[ 13] & C[ 12]);
        C[ 15] = G8[ 14] | (P7[ 14] & C[ 14]);
        C[ 16] = (word_mode != MODE_16) ? (G8[ 15] | (P7[ 15] & C[  0])) : 1'b0;
        C[ 17] = G8[ 16] | (P7[ 16] & C[ 16]);
        C[ 18] = G8[ 17] | (P7[ 17] & C[ 16]);
        C[ 19] = G8[ 18] | (P7[ 18] & C[ 18]);
        C[ 20] = G8[ 19] | (P7[ 19] & C[ 16]);
        C[ 21] = G8[ 20] | (P7[ 20] & C[ 20]);
        C[ 22] = G8[ 21] | (P7[ 21] & C[ 20]);
        C[ 23] = G8[ 22] | (P7[ 22] & C[ 22]);
        C[ 24] = G8[ 23] | (P7[ 23] & C[ 16]);
        C[ 25] = G8[ 24] | (P7[ 24] & C[ 24]);
        C[ 26] = G8[ 25] | (P7[ 25] & C[ 24]);
        C[ 27] = G8[ 26] | (P7[ 26] & C[ 26]);
        C[ 28] = G8[ 27] | (P7[ 27] & C[ 24]);
        C[ 29] = G8[ 28] | (P7[ 28] & C[ 28]);
        C[ 30] = G8[ 29] | (P7[ 29] & C[ 28]);
        C[ 31] = G8[ 30] | (P7[ 30] & C[ 30]);
        C[ 32] = (word_mode == MODE_64) ? (G8[ 31] | (P7[ 31] & C[  0])) : 1'b0;
        C[ 33] = G8[ 32] | (P7[ 32] & C[ 32]);
        C[ 34] = G8[ 33] | (P7[ 33] & C[ 32]);
        C[ 35] = G8[ 34] | (P7[ 34] & C[ 34]);
        C[ 36] = G8[ 35] | (P7[ 35] & C[ 32]);
        C[ 37] = G8[ 36] | (P7[ 36] & C[ 36]);
        C[ 38] = G8[ 37] | (P7[ 37] & C[ 36]);
        C[ 39] = G8[ 38] | (P7[ 38] & C[ 38]);
        C[ 40] = G8[ 39] | (P7[ 39] & C[ 32]);
        C[ 41] = G8[ 40] | (P7[ 40] & C[ 40]);
        C[ 42] = G8[ 41] | (P7[ 41] & C[ 40]);
        C[ 43] = G8[ 42] | (P7[ 42] & C[ 42]);
        C[ 44] = G8[ 43] | (P7[ 43] & C[ 40]);
        C[ 45] = G8[ 44] | (P7[ 44] & C[ 44]);
        C[ 46] = G8[ 45] | (P7[ 45] & C[ 44]);
        C[ 47] = G8[ 46] | (P7[ 46] & C[ 46]);
        C[ 48] = (word_mode != MODE_16) ? (G8[ 47] | (P7[ 47] & C[ 32])) : 1'b0;
        C[ 49] = G8[ 48] | (P7[ 48] & C[ 48]);
        C[ 50] = G8[ 49] | (P7[ 49] & C[ 48]);
        C[ 51] = G8[ 50] | (P7[ 50] & C[ 50]);
        C[ 52] = G8[ 51] | (P7[ 51] & C[ 48]);
        C[ 53] = G8[ 52] | (P7[ 52] & C[ 52]);
        C[ 54] = G8[ 53] | (P7[ 53] & C[ 52]);
        C[ 55] = G8[ 54] | (P7[ 54] & C[ 54]);
        C[ 56] = G8[ 55] | (P7[ 55] & C[ 48]);
        C[ 57] = G8[ 56] | (P7[ 56] & C[ 56]);
        C[ 58] = G8[ 57] | (P7[ 57] & C[ 56]);
        C[ 59] = G8[ 58] | (P7[ 58] & C[ 58]);
        C[ 60] = G8[ 59] | (P7[ 59] & C[ 56]);
        C[ 61] = G8[ 60] | (P7[ 60] & C[ 60]);
        C[ 62] = G8[ 61] | (P7[ 61] & C[ 60]);
        C[ 63] = G8[ 62] | (P7[ 62] & C[ 62]);
        C[ 64] = (word_mode == MODE_64) ? (G8[ 63] | (P7[ 63] & C[  0])) : 1'b0;
        C[ 65] = G8[ 64] | (P7[ 64] & C[ 64]);
        C[ 66] = G8[ 65] | (P7[ 65] & C[ 64]);
        C[ 67] = G8[ 66] | (P7[ 66] & C[ 66]);
        C[ 68] = G8[ 67] | (P7[ 67] & C[ 64]);
        C[ 69] = G8[ 68] | (P7[ 68] & C[ 68]);
        C[ 70] = G8[ 69] | (P7[ 69] & C[ 68]);
        C[ 71] = G8[ 70] | (P7[ 70] & C[ 70]);
        C[ 72] = G8[ 71] | (P7[ 71] & C[ 64]);
        C[ 73] = G8[ 72] | (P7[ 72] & C[ 72]);
        C[ 74] = G8[ 73] | (P7[ 73] & C[ 72]);
        C[ 75] = G8[ 74] | (P7[ 74] & C[ 74]);
        C[ 76] = G8[ 75] | (P7[ 75] & C[ 72]);
        C[ 77] = G8[ 76] | (P7[ 76] & C[ 76]);
        C[ 78] = G8[ 77] | (P7[ 77] & C[ 76]);
        C[ 79] = G8[ 78] | (P7[ 78] & C[ 78]);
        C[ 80] = (word_mode != MODE_16) ? (G8[ 79] | (P7[ 79] & C[ 64])) : 1'b0;
        C[ 81] = G8[ 80] | (P7[ 80] & C[ 80]);
        C[ 82] = G8[ 81] | (P7[ 81] & C[ 80]);
        C[ 83] = G8[ 82] | (P7[ 82] & C[ 82]);
        C[ 84] = G8[ 83] | (P7[ 83] & C[ 80]);
        C[ 85] = G8[ 84] | (P7[ 84] & C[ 84]);
        C[ 86] = G8[ 85] | (P7[ 85] & C[ 84]);
        C[ 87] = G8[ 86] | (P7[ 86] & C[ 86]);
        C[ 88] = G8[ 87] | (P7[ 87] & C[ 80]);
        C[ 89] = G8[ 88] | (P7[ 88] & C[ 88]);
        C[ 90] = G8[ 89] | (P7[ 89] & C[ 88]);
        C[ 91] = G8[ 90] | (P7[ 90] & C[ 90]);
        C[ 92] = G8[ 91] | (P7[ 91] & C[ 88]);
        C[ 93] = G8[ 92] | (P7[ 92] & C[ 92]);
        C[ 94] = G8[ 93] | (P7[ 93] & C[ 92]);
        C[ 95] = G8[ 94] | (P7[ 94] & C[ 94]);
        C[ 96] = (word_mode == MODE_64) ? (G8[ 95] | (P7[ 95] & C[ 64])) : 1'b0;
        C[ 97] = G8[ 96] | (P7[ 96] & C[ 96]);
        C[ 98] = G8[ 97] | (P7[ 97] & C[ 96]);
        C[ 99] = G8[ 98] | (P7[ 98] & C[ 98]);
        C[100] = G8[ 99] | (P7[ 99] & C[ 96]);
        C[101] = G8[100] | (P7[100] & C[100]);
        C[102] = G8[101] | (P7[101] & C[100]);
        C[103] = G8[102] | (P7[102] & C[102]);
        C[104] = G8[103] | (P7[103] & C[ 96]);
        C[105] = G8[104] | (P7[104] & C[104]);
        C[106] = G8[105] | (P7[105] & C[104]);
        C[107] = G8[106] | (P7[106] & C[106]);
        C[108] = G8[107] | (P7[107] & C[104]);
        C[109] = G8[108] | (P7[108] & C[108]);
        C[110] = G8[109] | (P7[109] & C[108]);
        C[111] = G8[110] | (P7[110] & C[110]);
        C[112] = (word_mode != MODE_16) ? (G8[111] | (P7[111] & C[ 96])) : 1'b0;
        C[113] = G8[112] | (P7[112] & C[112]);
        C[114] = G8[113] | (P7[113] & C[112]);
        C[115] = G8[114] | (P7[114] & C[114]);
        C[116] = G8[115] | (P7[115] & C[112]);
        C[117] = G8[116] | (P7[116] & C[116]);
        C[118] = G8[117] | (P7[117] & C[116]);
        C[119] = G8[118] | (P7[118] & C[118]);
        C[120] = G8[119] | (P7[119] & C[112]);
        C[121] = G8[120] | (P7[120] & C[120]);
        C[122] = G8[121] | (P7[121] & C[120]);
        C[123] = G8[122] | (P7[122] & C[122]);
        C[124] = G8[123] | (P7[123] & C[120]);
        C[125] = G8[124] | (P7[124] & C[124]);
        C[126] = G8[125] | (P7[125] & C[124]);
        C[127] = G8[126] | (P7[126] & C[126]);
        C[128] = (word_mode == MODE_64) ? (G8[127] | (P7[127] & C[  0])) : 1'b0;
        C[129] = G8[128] | (P7[128] & C[128]);
        C[130] = G8[129] | (P7[129] & C[128]);
        C[131] = G8[130] | (P7[130] & C[130]);
        C[132] = G8[131] | (P7[131] & C[128]);
        C[133] = G8[132] | (P7[132] & C[132]);
        C[134] = G8[133] | (P7[133] & C[132]);
        C[135] = G8[134] | (P7[134] & C[134]);
        C[136] = G8[135] | (P7[135] & C[128]);
        C[137] = G8[136] | (P7[136] & C[136]);
        C[138] = G8[137] | (P7[137] & C[136]);
        C[139] = G8[138] | (P7[138] & C[138]);
        C[140] = G8[139] | (P7[139] & C[136]);
        C[141] = G8[140] | (P7[140] & C[140]);
        C[142] = G8[141] | (P7[141] & C[140]);
        C[143] = G8[142] | (P7[142] & C[142]);
        C[144] = (word_mode != MODE_16) ? (G8[143] | (P7[143] & C[128])) : 1'b0;
        C[145] = G8[144] | (P7[144] & C[144]);
        C[146] = G8[145] | (P7[145] & C[144]);
        C[147] = G8[146] | (P7[146] & C[146]);
        C[148] = G8[147] | (P7[147] & C[144]);
        C[149] = G8[148] | (P7[148] & C[148]);
        C[150] = G8[149] | (P7[149] & C[148]);
        C[151] = G8[150] | (P7[150] & C[150]);
        C[152] = G8[151] | (P7[151] & C[144]);
        C[153] = G8[152] | (P7[152] & C[152]);
        C[154] = G8[153] | (P7[153] & C[152]);
        C[155] = G8[154] | (P7[154] & C[154]);
        C[156] = G8[155] | (P7[155] & C[152]);
        C[157] = G8[156] | (P7[156] & C[156]);
        C[158] = G8[157] | (P7[157] & C[156]);
        C[159] = G8[158] | (P7[158] & C[158]);
        C[160] = (word_mode == MODE_64) ? (G8[159] | (P7[159] & C[128])) : 1'b0;
        C[161] = G8[160] | (P7[160] & C[160]);
        C[162] = G8[161] | (P7[161] & C[160]);
        C[163] = G8[162] | (P7[162] & C[162]);
        C[164] = G8[163] | (P7[163] & C[160]);
        C[165] = G8[164] | (P7[164] & C[164]);
        C[166] = G8[165] | (P7[165] & C[164]);
        C[167] = G8[166] | (P7[166] & C[166]);
        C[168] = G8[167] | (P7[167] & C[160]);
        C[169] = G8[168] | (P7[168] & C[168]);
        C[170] = G8[169] | (P7[169] & C[168]);
        C[171] = G8[170] | (P7[170] & C[170]);
        C[172] = G8[171] | (P7[171] & C[168]);
        C[173] = G8[172] | (P7[172] & C[172]);
        C[174] = G8[173] | (P7[173] & C[172]);
        C[175] = G8[174] | (P7[174] & C[174]);
        C[176] = (word_mode != MODE_16) ? (G8[175] | (P7[175] & C[160])) : 1'b0;
        C[177] = G8[176] | (P7[176] & C[176]);
        C[178] = G8[177] | (P7[177] & C[176]);
        C[179] = G8[178] | (P7[178] & C[178]);
        C[180] = G8[179] | (P7[179] & C[176]);
        C[181] = G8[180] | (P7[180] & C[180]);
        C[182] = G8[181] | (P7[181] & C[180]);
        C[183] = G8[182] | (P7[182] & C[182]);
        C[184] = G8[183] | (P7[183] & C[176]);
        C[185] = G8[184] | (P7[184] & C[184]);
        C[186] = G8[185] | (P7[185] & C[184]);
        C[187] = G8[186] | (P7[186] & C[186]);
        C[188] = G8[187] | (P7[187] & C[184]);
        C[189] = G8[188] | (P7[188] & C[188]);
        C[190] = G8[189] | (P7[189] & C[188]);
        C[191] = G8[190] | (P7[190] & C[190]);
        C[192] = (word_mode == MODE_64) ? (G8[191] | (P7[191] & C[128])) : 1'b0;
        C[193] = G8[192] | (P7[192] & C[192]);
        C[194] = G8[193] | (P7[193] & C[192]);
        C[195] = G8[194] | (P7[194] & C[194]);
        C[196] = G8[195] | (P7[195] & C[192]);
        C[197] = G8[196] | (P7[196] & C[196]);
        C[198] = G8[197] | (P7[197] & C[196]);
        C[199] = G8[198] | (P7[198] & C[198]);
        C[200] = G8[199] | (P7[199] & C[192]);
        C[201] = G8[200] | (P7[200] & C[200]);
        C[202] = G8[201] | (P7[201] & C[200]);
        C[203] = G8[202] | (P7[202] & C[202]);
        C[204] = G8[203] | (P7[203] & C[200]);
        C[205] = G8[204] | (P7[204] & C[204]);
        C[206] = G8[205] | (P7[205] & C[204]);
        C[207] = G8[206] | (P7[206] & C[206]);
        C[208] = (word_mode != MODE_16) ? (G8[207] | (P7[207] & C[192])) : 1'b0;
        C[209] = G8[208] | (P7[208] & C[208]);
        C[210] = G8[209] | (P7[209] & C[208]);
        C[211] = G8[210] | (P7[210] & C[210]);
        C[212] = G8[211] | (P7[211] & C[208]);
        C[213] = G8[212] | (P7[212] & C[212]);
        C[214] = G8[213] | (P7[213] & C[212]);
        C[215] = G8[214] | (P7[214] & C[214]);
        C[216] = G8[215] | (P7[215] & C[208]);
        C[217] = G8[216] | (P7[216] & C[216]);
        C[218] = G8[217] | (P7[217] & C[216]);
        C[219] = G8[218] | (P7[218] & C[218]);
        C[220] = G8[219] | (P7[219] & C[216]);
        C[221] = G8[220] | (P7[220] & C[220]);
        C[222] = G8[221] | (P7[221] & C[220]);
        C[223] = G8[222] | (P7[222] & C[222]);
        C[224] = (word_mode == MODE_64) ? (G8[223] | (P7[223] & C[192])) : 1'b0;
        C[225] = G8[224] | (P7[224] & C[224]);
        C[226] = G8[225] | (P7[225] & C[224]);
        C[227] = G8[226] | (P7[226] & C[226]);
        C[228] = G8[227] | (P7[227] & C[224]);
        C[229] = G8[228] | (P7[228] & C[228]);
        C[230] = G8[229] | (P7[229] & C[228]);
        C[231] = G8[230] | (P7[230] & C[230]);
        C[232] = G8[231] | (P7[231] & C[224]);
        C[233] = G8[232] | (P7[232] & C[232]);
        C[234] = G8[233] | (P7[233] & C[232]);
        C[235] = G8[234] | (P7[234] & C[234]);
        C[236] = G8[235] | (P7[235] & C[232]);
        C[237] = G8[236] | (P7[236] & C[236]);
        C[238] = G8[237] | (P7[237] & C[236]);
        C[239] = G8[238] | (P7[238] & C[238]);
        C[240] = (word_mode != MODE_16) ? (G8[239] | (P7[239] & C[224])) : 1'b0;
        C[241] = G8[240] | (P7[240] & C[240]);
        C[242] = G8[241] | (P7[241] & C[240]);
        C[243] = G8[242] | (P7[242] & C[242]);
        C[244] = G8[243] | (P7[243] & C[240]);
        C[245] = G8[244] | (P7[244] & C[244]);
        C[246] = G8[245] | (P7[245] & C[244]);
        C[247] = G8[246] | (P7[246] & C[246]);
        C[248] = G8[247] | (P7[247] & C[240]);
        C[249] = G8[248] | (P7[248] & C[248]);
        C[250] = G8[249] | (P7[249] & C[248]);
        C[251] = G8[250] | (P7[250] & C[250]);
        C[252] = G8[251] | (P7[251] & C[248]);
        C[253] = G8[252] | (P7[252] & C[252]);
        C[254] = G8[253] | (P7[253] & C[252]);
        C[255] = G8[254] | (P7[254] & C[254]);
        C[256] = G8[255] | (P7[255] & C[127]);
    end

    // Step 4: Final sum
    generate
        for (i = 0; i < 256; i++) begin : sum_gen
            assign sum[i] = P[i] ^ C[i];
        end
    endgenerate

    assign cout = (word_mode == MODE_64) ? C[256] : 1'b0;

endmodule

